
# 脑机接口智能小车控制系统 (BCI-TurboPi) 操作指南

本项目旨在通过采集脑电信号（NeuroSky），利用随机森林算法识别 5 种意图（前进、后退、左转、右转、停止），并通过 WiFi 控制 TurboPi 智能小车完成特定路径任务。

---

## 📂 1. 环境配置 (Environment Setup)

本项目需要在 **电脑端 (Client)** 配置 Python 运行环境。请按照以下步骤使用 Conda 创建独立环境。

### 1.1 前置准备
确保已安装 [Miniconda](https://docs.conda.io/en/latest/miniconda.html) 或 Anaconda。

### 1.2 创建并激活虚拟环境
打开终端（CMD / PowerShell / PyCharm Terminal），依次运行：

```bash
# 1. 创建名为 controlCar 的虚拟环境 (指定 Python 3.13 以保证兼容性)
conda create -n controlCar python=3.13

# 2. 激活环境
conda activate controlCar
```

### 1.3 安装依赖库
确保项目根目录下有 `requirements.txt` 文件，然后运行：

```bash
# 使用 pip 安装所有依赖 (scikit-learn, pandas, pyserial, neuropy 等)
pip install -r requirements.txt
```

---

## 🚗 2. 硬件连接指南 (Hardware Connection)

在运行控制程序前，必须确保小车已准备就绪并开启监听模式。

### 2.1 树莓派小车启动
1.  **开机**：打开树莓派小车电源开关，等待约 30 秒，直到听到 **“滴”** 的一声启动音。
2.  **检查模式**：观察小车扩展板上的 LED 灯状态：
    *   **慢速闪烁**：直连模式（AP Mode）。
    *   **快速闪烁**：局域网模式（LAN Mode）。
    *   *注意：如果处于慢闪，请使用手机 App 将其配置为局域网模式。*
3.  **连接 WiFi**：确保小车和你的电脑连接到 **同一个 WiFi**。连接成功后，扩展板上的 LED 灯将变为 **常亮（停止闪烁）**。

### 2.2 启动接收程序 (Server)
1.  **获取 IP**：通过手机热点管理页面或局域网扫描工具，查看树莓派的 IP 地址。
2.  **SSH 连接**：
    *   在 VS Code 中使用 `Remote-SSH` 插件连接小车。
    *   Host: `pi@小车IP地址`
    *   Password: `123456` (或你们修改后的密码)
3.  **运行监听脚本**：
    在 VS Code 的终端中输入以下指令启动接收器：
    ```bash
    cd /home/pi/TurboPi/HiwonderSDK
    sudo python3 receiver.py
    ```
    *看到 "Waiting for connection..." 或类似提示即表示小车已就绪。*

---

## 💻 3. 软件使用流程 (Usage Workflow)

>请先佩戴并确保脑环打开，然后在 **电脑端 (Local PC)** 为该项目**配置刚刚conda创建的controlCar的环境**，然后在该项目中按顺序运行以下脚本。

### 3.1 数据采集
运行 `1_collect_data.py`：
*   程序会引导被试者依次进行 5 种动作（前、后、左、右、停）的录入。
*   **注意**：每种动作采集时长约为 **10秒**（可根据实际情况在代码中调整 `SAMPLES_PER_ACTION`）。
*   采集完成后会生成 `brain_data.csv`。

### 3.2 模型训练
运行 `2_train_model.py`：
*   程序读取 CSV 数据并训练随机森林模型。
*   训练完成后，控制台会输出 **离线准确率**，并生成模型文件 `brain_model.pkl`。

### 3.3 实时控制
运行 `3_control_car.py`：
*   **前置条件**：确保小车端的 `receiver.py` 正在运行。
*   程序加载模型，实时读取脑电信号并发送指令给小车。

---

## 🧪 4. 科研测试流程 (Experimental Protocol)

为验证系统性能，请对 **10名被试者** 严格按照以下流程进行测试并记录数据。

### 阶段 1：个体化校准 (Calibration)
*   **佩戴检查**：确保 NeuroSky 设备佩戴正确，信号质量指示灯正常。
*   **数据录入**：运行采集脚本，引导被试者完成 5 种意图的采集。
*   **模型生成**：运行训练脚本，记录 **离线交叉验证准确率 (Offline Accuracy)**。

### 阶段 2：静态指令响应测试 (Static Test)
**目的**：测试无干扰环境下的指令识别准确率。

1.  **设置**：架空小车（或仅观察电脑终端输出），避免误触跑动。
2.  **流程**：电脑屏幕随机显示一个文字指令（如“左转”），持续 5 秒。
3.  **执行**：被试者看到指令后，立即执行对应意念动作。
4.  **记录**：测试人员人工记录识别结果是否正确（每种动作测 5 次，共 25 次）。
5.  **计算**：
    $$ \text{静态准确率} = \frac{\text{系统正确识别次数}}{25} \times 100\% $$

### 阶段 3：动态任务综合测试 (Dynamic Task)
**目的**：测试实际场景下的综合控制能力。

1.  **任务路径**：
    *   起点 -> 直行 2 米
    *   -> 原地左转一圈 (360°)
    *   -> 原地右转一圈 (360°)
    *   -> 倒车回到原点
2.  **记录指标**：
    *   **完成时间 (Time)**：从发出第一个指令到完全停止的时间。
    *   **碰撞次数 (Collisions)**：偏离跑道或撞墙次数。
    *   **误触发次数 (False Positives)**：意图为“停止”时却误判为“前进”等危险动作的次数。

---

## 📝 5. 数据记录表 (Data Recording Sheet)

请为每位被试者填写此表：

**被试者编号：__________  性别：__________  日期：__________**

| 测试阶段 | 指标名称 | 数据记录 | 备注 |
| :--- | :--- | :--- | :--- |
| **1. 离线训练** | 模型验证准确率 | _______ % | 训练脚本输出值 |
| **2. 静态测试** | 总尝试次数 | 25 次 | 每动作5次 |
| | 正确识别次数 | _______ 次 | |
| | **在线准确率** | **_______ %** | |
| **3. 动态跑道** | 任务完成时间 | _______ 秒 | |
| | 碰撞/出界次数 | _______ 次 | |
| | 意外误触次数 | _______ 次 | (安全性评估) |
| **4. 主观反馈** | 疲劳度 (1-10) | _______ | 10为非常疲劳 |

---